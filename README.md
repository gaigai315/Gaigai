# 📚 Gaigai 记忆表格扩展

<div align="center">

![版本](https://img.shields.io/badge/版本-0.8.3-blue)
![兼容](https://img.shields.io/badge/SillyTavern-1.12.0+-green)
![许可](https://img.shields.io/badge/许可-MIT-orange)

**一个强大的 SillyTavern 角色扮演记忆管理扩展**

[安装](#-安装方法) • [功能](#-核心功能) • [使用](#-使用指南) • [配置](#-高级配置) • [更新日志](#-更新日志)

</div>

---

## 📖 简介

Gaigai 记忆表格是一个为 SillyTavern 设计的智能记忆管理系统，能够自动从 AI 回复中提取并存储结构化数据，支持云同步、AI 总结、可视化编辑等功能，让你的角色扮演体验更加沉浸和连贯。

### ✨ 为什么使用 Gaigai？

- 🧠 **智能记忆**：自动解析 AI 输出，无缝记录剧情、人物、物品等信息
- ☁️ **云端同步**：数据保存在聊天文件中，跨设备自动同步
- 🤖 **AI 总结**：支持调用 AI 对表格数据进行智能总结
- 🎨 **可视化管理**：美观的表格界面，支持搜索、筛选、批量编辑
- 📱 **响应式设计**：完美支持手机、平板、电脑多端使用

---

## 🚀 安装方法

### 方法一：通过 URL 安装（推荐）

1. 打开 **SillyTavern**
2. 点击右上角 **扩展菜单**（☰ 图标）
3. 滚动到底部，点击 **"Download Extensions & Assets"**
4. 在 **"Install Extension"** 输入框中粘贴：
   ```
   https://github.com/gaigai315/Gaigai
   ```
5. 点击 **"Save"** 按钮
6. 等待安装完成，刷新页面

### 方法二：手动安装

1. 下载本仓库（Code → Download ZIP）
2. 解压到 `SillyTavern/data/default-user/extensions/third-party/Gaigai`
3. 重启 SillyTavern

---

## 🎯 核心功能

### 📊 9 大表格系统

| 表格名称 | 用途 | 列结构 |
|---------|------|--------|
| 主线剧情 | 记录主要故事线进展 | 日期、开始时间、完结时间、事件概要、状态 |
| 支线追踪 | 追踪支线任务 | 状态、支线名、开始时间、完结时间、事件追踪、关键NPC |
| 角色状态 | 记录角色状态变化 | 角色名、状态变化、时间、原因、当前位置 |
| 人物档案 | 保存人物基本信息 | 姓名、年龄、身份、地点、性格、备注 |
| 人物关系 | 记录角色间关系 | 角色A、角色B、关系描述、情感态度 |
| 世界设定 | 记录世界观设定 | 设定名、类型、详细说明、影响范围 |
| 物品追踪 | 管理重要物品 | 物品名称、物品描述、当前位置、持有者、状态、重要程度、备注 |
| 约定 | 记录角色间的约定 | 约定时间、约定内容、核心角色 |
| 记忆总结 | AI 生成的智能总结 | 表格类型、总结内容 |

### 🔧 主要功能

- ✅ **自动解析 AI 标签**：识别 `<GaigaiMemory>` 标签，自动更新表格
- ☁️ **云端同步**：数据保存在 `chatMetadata`，跟随聊天文件自动同步
- 💾 **本地备份**：同时保存到 LocalStorage，双重保护
- 🔍 **搜索与筛选**：快速查找表格内容
- ✏️ **双击编辑**：双击单元格打开大文本编辑器
- 📏 **列宽调整**：拖拽列边框自定义列宽
- ✅ **批量操作**：多选行，批量删除
- 📥 **导出数据**：导出 JSON 格式备份
- 🎨 **主题自定义**：自定义表头颜色和背景色
- 🤖 **AI 智能总结**：一键生成表格总结，节省 Token

---

## 📝 使用指南

### 1. 基础使用

#### 打开记忆表格

1. 点击右上角 **扩展菜单（☰）**
2. 找到并点击 **"记忆表格"**
3. 弹出表格管理界面

#### 手动添加数据

1. 切换到目标表格（点击顶部标签）
2. 点击 **"➕ 新增"** 按钮
3. 在单元格中直接编辑内容
4. 双击单元格可打开大文本编辑器

#### 删除数据

- **单行删除**：勾选行前的复选框，点击 **"🗑️ 删除选中"**
- **批量删除**：勾选多行，点击 **"🗑️ 删除选中"**
- **快捷键**：选中行后按 `Delete` 键

### 2. AI 自动记录

#### 在角色卡中添加提示词

在角色卡的 **System Prompt** 或 **Post-History Instructions** 中添加：

```
【记忆标签格式】
你必须在每次回复的最底端，使用以下格式记录关键信息：

<GaigaiMemory><!-- insertRow(表格索引, {列号: "内容", ...}) --></GaigaiMemory>

【表格索引】
0: 主线剧情 | 1: 支线追踪 | 2: 角色状态 | 3: 人物档案 | 4: 人物关系 
5: 世界设定 | 6: 物品追踪 | 7: 约定

【示例】
新增人物：<GaigaiMemory><!-- insertRow(3, {0: "艾莉娅", 1: "23", 2: "商人", 3: "森林", 4: "神秘", 5: "擅长占卜"}) --></GaigaiMemory>
更新主线：<GaigaiMemory><!-- updateRow(0, 0, {3: "接受委托；遇到艾莉娅"}) --></GaigaiMemory>
```

#### 或使用内置提示词（推荐）

1. 打开记忆表格 → 点击 **"⚙️"** → 选择 **"📝 提示词管理"**
2. 选择提示词注入位置（默认：系统消息）
3. 点击保存

### 3. AI 总结功能

#### 配置 AI 总结

1. 打开 **"⚙️ 配置"** → **"🤖 AI 总结配置"**
2. 选择 API 模式：
   - **酒馆 API**（推荐）：使用当前连接的 API，无需配置
   - **独立 API**：使用单独的 API（可与酒馆分离）

#### 生成总结

1. 点击 **"📝 总结"** 按钮
2. 等待 AI 生成总结（只发送表格数据，不包含聊天记录）
3. 预览并编辑总结内容
4. 点击 **"✅ 保存总结"**
5. 选择是否清空已总结的原始数据

#### 自动总结

1. 打开 **"⚙️ 配置"** → 勾选 **"启用自动总结"**
2. 设置触发楼层数（默认 50 条消息）
3. 达到指定消息数后自动生成总结

---

## ⚙️ 高级配置

### 表格数据注入

- **启用注入**：将表格数据注入到 AI 上下文
- **注入位置**：系统消息 / 用户消息 / 助手消息
- **位置类型**：相对位置（固定）/ 聊天位置（动态）
- **深度**：偏移量（仅动态模式）

### 提示词管理

- **填表提示词**：每次聊天都会发送给 AI
- **总结提示词**：仅在生成总结时使用

### 其他选项

- **控制台详细日志**：输出调试信息
- **每个角色独立数据**：不同角色使用独立存储
- **隐藏聊天中的记忆标签**：在聊天界面隐藏 `<GaigaiMemory>` 标签
- **自动过滤历史标签**：防止标签被发送给 AI

---

## 🎨 主题自定义

1. 点击 **"🎨"** 按钮
2. 选择主题色（控制按钮和表头颜色）
3. 选择背景色（控制弹窗背景）
4. 点击 **"💾 保存"**

---

## 💾 数据存储与同步

### 存储机制

- **云端存储**：保存在 `chatMetadata.gaigai`，跟随聊天文件
- **本地备份**：保存在 `localStorage`，作为双重保护

### 跨设备同步

如果你使用了云同步工具（如 Syncthing、OneDrive、坚果云等）同步 SillyTavern 的数据文件夹：

1. 在设备 A 添加/修改数据
2. 等待云同步完成
3. 在设备 B 打开同一个聊天
4. 自动加载云端数据

### 手动导出/导入（未来版本）

- 点击 **"📥 导出"** 下载 JSON 文件
- 将文件传输到其他设备手动导入

---

## 🔍 常见问题

### Q: 按钮不见了/扩展不显示？

**A:** 
1. 检查控制台是否有报错（按 F12）
2. 确认 `manifest.json` 文件存在
3. 尝试重启 SillyTavern
4. 检查路径：`data/default-user/extensions/third-party/Gaigai`

### Q: 数据没有同步？

**A:**
1. 打开控制台，查看是否显示 "✅ 云同步成功"
2. 检查 "⚙️ 配置" 中的 `cloudSync` 是否开启
3. 确保打开了聊天（不是首页）
4. 发送一条消息触发酒馆保存

### Q: 复选框无法点击？

**A:** 已在 v0.8.3 修复，请更新到最新版本

### Q: AI 不输出记忆标签？

**A:**
1. 检查提示词是否正确添加到角色卡
2. 尝试在对话中明确提醒 AI："请使用 GaigaiMemory 标签记录信息"
3. 使用内置提示词功能（更稳定）

### Q: 如何清空所有数据？

**A:** 点击 **"🗑️ 全清"** 按钮（建议先导出备份）

---

## 🛠️ 技术细节

### 依赖项

- SillyTavern 1.12.0+
- jQuery 3.5+

### 文件结构

```
Gaigai/
├── index.js          # 主逻辑（压缩格式）
├── style.css         # 样式表
├── manifest.json     # 扩展清单
└── README.md         # 说明文档
```

### 数据格式

```javascript
{
  "v": "0.8.3",
  "id": "角色名_聊天ID",
  "ts": 1234567890,
  "d": [
    { "n": "表格名", "c": ["列1", "列2"], "r": [{0: "值1", 1: "值2"}] }
  ],
  "summarized": { "0": [1, 2, 3] },
  "ui": { "c": "#9c4c4c", "bc": "#ffffff" },
  "colWidths": { "0": { "日期": 110 } }
}
```

---

## 📅 更新日志

### v0.8.3 (2025-01-13) - 当前版本
- ✅ 修复云同步功能（使用正确的 `chatMetadata` API）
- ✅ 修复复选框无法点击问题
- ✅ 优化列宽拖拽体验（参考 Excel）
- ✅ 添加批量删除功能
- ✅ 移除自定义弹窗，使用原生样式
- ✅ 优化移动端触摸响应
- 🐛 修复 `chat_metadata` 命名错误
- 🐛 修复复选框事件冲突

### v0.8.2
- 新增 AI 总结功能
- 支持独立 API 配置
- 新增记忆总结表格
- 优化提示词管理

### v0.8.0
- 重构数据存储机制
- 支持云同步
- 新增主题自定义
- 新增列宽调整

### v0.5.0
- 初始发布
- 8 个基础表格
- 自动解析标签

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📄 许可证

MIT License

---

## 💬 联系作者

- GitHub: [@gaigai315](https://github.com/gaigai315)
- 问题反馈: [Issues](https://github.com/gaigai315/Gaigai/issues)

---

<div align="center">

**如果觉得好用，请给个 ⭐ Star！**

Made with ❤️ for SillyTavern Community

</div>
